/*

 Copyright (c) 2011 Sencha Labs - Author: Nicolas Garcia Belmonte (http://philogb.github.com/)

 Permission is hereby granted, free of charge, to any person obtaining a copy
 of this software and associated documentation files (the "Software"), to deal
 in the Software without restriction, including without limitation the rights
 to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 copies of the Software, and to permit persons to whom the Software is
 furnished to do so, subject to the following conditions:

 The above copyright notice and this permission notice shall be included in
 all copies or substantial portions of the Software.

 THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
 THE SOFTWARE.

*/
(function(){function s(x){return document.getElementById(x)}this.PhiloGL=null;(function(){PhiloGL=function(x,y){function p(u,A,t){var v=u.canvas,a=new PhiloGL.Camera(f.fov,v.width/v.height,f.near,f.far,f);a.update();var b=new PhiloGL.Scene(A,a,c);I=new PhiloGL.WebGL.Application({gl:u,canvas:v,program:A,scene:b,camera:a});A.$$family=="program"&&A.use();d&&PhiloGL.Events.create(I,s.extend(d,{bind:I}));if(h.src.length)new PhiloGL.IO.Textures(s.extend(h,{onComplete:function(){t(I)}}));else t(I)}y=s.merge({context:{},
camera:{fov:45,near:0.1,far:500},program:{from:"defaults",vs:"Default",fs:"Default"},scene:{},textures:{src:[]},events:{},onLoad:s.empty,onError:s.empty},y||{});var k=y.context,f=y.camera,d=y.events,h=y.textures,i=s.splat(y.program),c=y.scene;o=PhiloGL.WebGL.getContext(x,k);if(!o){y.onError("The WebGL context couldn't been initialized");return null}var l={defaults:"fromDefaultShaders",ids:"fromShaderIds",sources:"fromShaderSources",uris:"fromShaderURIs"},j=i.length,n=function(){var u=j,A={},t=false;
return{onSuccess:function(v,a){A[a.id||j-u]=v;u--;if(u===0&&!t)p(o,j==1?v:A,function(b){y.onLoad(b)})},onError:function(v){u--;y.onError(v);t=true}}}();i.forEach(function(u){var A=u.from,t,v;for(v in l)if(A==v){try{t=PhiloGL.Program[l[v]](s.extend(n,u))}catch(a){n.onError(a)}break}if(t)n.onSuccess(t,u)})}})();PhiloGL.unpack=function(x){x=x||aa;["Vec3","Mat4","Quat","Camera","Program","WebGL","O3D","Scene","Shaders","IO","Events","WorkerGroup","Fx","Media"].forEach(function(y){x[y]=PhiloGL[y]})};PhiloGL.version=
"1.4.2";var o,I,aa=this;s.empty=function(){};s.time=Date.now;s.uid=function(){var x=s.time();return function(){return x++}}();s.extend=function(x,y){for(var p in y)x[p]=y[p];return x};s.type=function(){var x=Object.prototype.toString;return function(y){var p;p=x.call(y);p=p.substr(8,p.length-9).toLowerCase();if(p!="object")return p;if(y.$$family)return y.$$family;return y&&y.nodeName&&y.nodeType==1?"element":p}}();(function(){function x(y){var p=s.type(y);if(p=="object"){p={};for(var k in y)p[k]=
x(y[k]);return p}else if(p=="array"){p=[];k=0;for(var f=y.length;k<f;k++)p[k]=x(y[k]);return p}else return y}s.merge=function(){for(var y={},p=0,k=arguments.length;p<k;p++){var f=arguments[p];if(s.type(f)=="object")for(var d in f){var h=f[d],i=y[d];y[d]=i&&s.type(h)=="object"&&s.type(i)=="object"?s.merge(i,h):x(h)}}return y}})();s.splat=function(){var x=Array.isArray;return function(y){return x(y)&&y||[y]}}();(function(){function x(p){for(var k in p)this[k]=p[k];this.buffers={};this.bufferMemo={};
this.frameBuffers={};this.frameBufferMemo={};this.renderBuffers={};this.renderBufferMemo={};this.textures={};this.textureMemo={}}var y={getContext:function(p,k){p=typeof p=="string"?s(p):p;var f;(f=p.getContext("experimental-webgl",k))||(f=p.getContext("webgl",k));if(f&&k&&k.debug){o={};for(var d in f){var h=f[d];o[d]=typeof h=="function"?function(i,c){return function(){console.log(i,Array.prototype.join.call(arguments),Array.prototype.slice.call(arguments));try{var l=c.apply(f,arguments)}catch(j){throw i+
" "+j;}for(var n=[],u;(u=f.getError())!==f.NO_ERROR;)n.push(u);if(n.length)throw n.join();return l}}(d,h):h}}else o=f;if(o)o.get=function(i){return typeof i=="string"?o[i]:i};return o}};x.prototype={$$family:"application",setBuffer:function(p,k,f){if(f===false||f===null){(f=this.bufferMemo[k])&&o.bindBuffer(f.bufferType,null);var d=f&&f.attribute||k;p=p.attributes[d];p!==undefined&&o.disableVertexAttribArray(p)}else{f=s.extend(this.bufferMemo[k]||{bufferType:o.ARRAY_BUFFER,size:1,dataType:o.FLOAT,
stride:0,offset:0,drawType:o.STATIC_DRAW},f||{});d=f.attribute||k;var h=f.bufferType,i=k in this.buffers,c=i?this.buffers[k]:o.createBuffer(),l="value"in f,j=f.value,n=f.size,u=f.dataType,A=f.stride,t=f.offset,v=f.drawType;p=p.attributes[d];var a=p!==undefined;i||(this.buffers[k]=c);a&&o.enableVertexAttribArray(p);o.bindBuffer(h,c);l&&o.bufferData(h,j,v);a&&o.vertexAttribPointer(p,n,u,false,A,t);delete f.value;this.bufferMemo[k]=f;if(a)this.bufferMemo[d]=f;return this}},setBuffers:function(p,k){for(var f in k)this.setBuffer(p,
f,k[f]);return this},setFrameBuffer:function(p,k){if(typeof k!="object")o.bindFramebuffer(o.FRAMEBUFFER,k?this.frameBuffers[p]:null);else{k=s.merge(this.frameBufferMemo[p]||{width:0,height:0,bindToTexture:false,textureOptions:{attachment:o.COLOR_ATTACHMENT0},bindToRenderBuffer:false,renderBufferOptions:{attachment:o.DEPTH_ATTACHMENT}},k||{});var f=k.bindToTexture,d=k.bindToRenderBuffer,h=p in this.frameBuffers,i=h?this.frameBuffers[p]:o.createFramebuffer(o.FRAMEBUFFER);o.bindFramebuffer(o.FRAMEBUFFER,
i);h||(this.frameBuffers[p]=i);if(f){f=s.merge({data:{width:k.width,height:k.height}},s.type(f)=="object"?f:{});h=p+"-texture";i=k.textureOptions;this.setTexture(h,f);o.framebufferTexture2D(o.FRAMEBUFFER,i.attachment,this.textureMemo[h].textureType,this.textures[h],0)}if(d){d=s.extend({width:k.width,height:k.height},s.type(d)=="object"?d:{});f=p+"-renderbuffer";h=k.renderBufferOptions;this.setRenderBuffer(f,d);o.framebufferRenderbuffer(o.FRAMEBUFFER,h.attachment,o.RENDERBUFFER,this.renderBuffers[f])}o.bindTexture(o.TEXTURE_2D,
null);o.bindRenderbuffer(o.RENDERBUFFER,null);o.bindFramebuffer(o.FRAMEBUFFER,null);this.frameBufferMemo[p]=k;return this}},setFrameBuffers:function(p){for(var k in p)this.setFrameBuffer(k,p[k]);return this},setRenderBuffer:function(p,k){if(typeof k!="object")o.bindRenderbuffer(o.RENDERBUFFER,k?this.renderBufferMemo[p]:null);else{k=s.extend(this.renderBufferMemo[p]||{storageType:o.DEPTH_COMPONENT16,width:0,height:0},k||{});var f=p in this.renderBuffers,d=f?this.renderBuffers[p]:o.createRenderbuffer(o.RENDERBUFFER);
f||(this.renderBuffers[p]=d);o.bindRenderbuffer(o.RENDERBUFFER,d);o.renderbufferStorage(o.RENDERBUFFER,k.storageType,k.width,k.height);this.renderBufferMemo[p]=k;return this}},setRenderBuffers:function(p){for(var k in p)this.setRenderBuffer(k,p[k]);return this},setTexture:function(p,k){if(!k||typeof k!="object"){o.activeTexture(k||o.TEXTURE0);o.bindTexture(this.textureMemo[p].textureType||o.TEXTURE_2D,this.textures[p])}else{k=s.merge(this.textureMemo[p]||{textureType:o.TEXTURE_2D,pixelStore:[{name:o.UNPACK_FLIP_Y_WEBGL,
value:true},{name:o.UNPACK_ALIGNMENT,value:1}],parameters:[{name:o.TEXTURE_MAG_FILTER,value:o.NEAREST},{name:o.TEXTURE_MIN_FILTER,value:o.NEAREST}],data:{format:o.RGBA,value:false,width:0,height:0,border:0}},k||{});var f="textureType"in k?o.get(k.textureType):o.TEXTURE_2D,d="textureTarget"in k?o.get(k.textureTarget):f,h=f==o.TEXTURE_CUBE_MAP,i=p in this.textures,c=i?this.textures[p]:o.createTexture(),l=k.pixelStore,j=k.parameters,n=k.data,u=n.value,A=n.format,t=!!n.value;i||(this.textures[p]=c);o.bindTexture(f,
c);i||l.forEach(function(v){v.name=typeof v.name=="string"?o[v.name]:v.name;o.pixelStorei(v.name,v.value)});if(t)if(h)for(c=0;c<6;++c)o.texImage2D(d[c],0,A,A,o.UNSIGNED_BYTE,u[c]);else o.texImage2D(d,0,A,A,o.UNSIGNED_BYTE,u);else if(n.width||n.height)o.texImage2D(d,0,A,n.width,n.height,n.border,A,o.UNSIGNED_BYTE,null);i||j.forEach(function(v){v.name=o.get(v.name);v.value=o.get(v.value);o.texParameteri(f,v.name,v.value);v.generateMipmap&&o.generateMipmap(f)});k.isCube=h;delete k.data;this.textureMemo[p]=
k;return this}},setTextures:function(p){for(var k in p)this.setTexture(k,p[k]);return this},use:function(p){o.useProgram(p.program);this.usedProgram=p;return this}};y.Application=x;(function(){try{var p=document.createElement("canvas");PhiloGL.hasWebGL=function(){return!!(window.WebGLRenderingContext&&(p.getContext("webgl")||p.getContext("experimental-webgl")))}}catch(k){PhiloGL.hasWebGL=function(){return false}}})();PhiloGL.WebGL=y})();(function(){function x(a){return{get:function(){return this[a]},
set:function(b){this[a]=b},configurable:false,enumerable:false}}var y=Math.sqrt,p=Math.sin,k=Math.cos,f=Math.tan,d=Math.PI,h=Array.prototype.slice,i=this.Float32Array,c=function(){if(!i||!i.call)return Array;try{i.call({},10)}catch(a){return Array}return i}(),l=c!=Array,j=function(a,b,g){if(l){i.call(this,3);this[0]=a||0;this[1]=b||0;this[2]=g||0}else this.push(a||0,b||0,g||0);this.typedContainer=new i(3)};j.create=function(){return new i(3)};j.prototype=Object.create(c.prototype,{$$family:{value:"Vec3"},
x:x(0),y:x(1),z:x(2)});var n={setVec3:function(a,b){a[0]=b[0];a[1]=b[1];a[2]=b[2];return a},set:function(a,b,g,m){a[0]=b;a[1]=g;a[2]=m;return a},add:function(a,b){return new j(a[0]+b[0],a[1]+b[1],a[2]+b[2])},$add:function(a,b){a[0]+=b[0];a[1]+=b[1];a[2]+=b[2];return a},add2:function(a,b,g){a[0]=b[0]+g[0];a[1]=b[1]+g[1];a[2]=b[2]+g[2];return a},sub:function(a,b){return new j(a[0]-b[0],a[1]-b[1],a[2]-b[2])},$sub:function(a,b){a[0]-=b[0];a[1]-=b[1];a[2]-=b[2];return a},sub2:function(a,b,g){a[0]=b[0]-
g[0];a[1]=b[1]-g[1];a[2]=b[2]-g[2];return a},scale:function(a,b){return new j(a[0]*b,a[1]*b,a[2]*b)},$scale:function(a,b){a[0]*=b;a[1]*=b;a[2]*=b;return a},neg:function(a){return new j(-a[0],-a[1],-a[2])},$neg:function(a){a[0]=-a[0];a[1]=-a[1];a[2]=-a[2];return a},unit:function(a){var b=j.norm(a);if(b>0)return j.scale(a,1/b);return j.clone(a)},$unit:function(a){var b=j.norm(a);if(b>0)return j.$scale(a,1/b);return a},cross:function(a,b){var g=a[0],m=a[1],q=a[2],r=b[0],w=b[1],z=b[2];return new j(m*
z-q*w,q*r-g*z,g*w-m*r)},$cross:function(a,b){var g=a[0],m=a[1],q=a[2],r=b[0],w=b[1],z=b[2];a[0]=m*z-q*w;a[1]=q*r-g*z;a[2]=g*w-m*r;return a},distTo:function(a,b){var g=a[0]-b[0],m=a[1]-b[1],q=a[2]-b[2];return y(g*g+m*m+q*q)},distToSq:function(a,b){var g=a[0]-b[0],m=a[1]-b[1],q=a[2]-b[2];return g*g+m*m+q*q},norm:function(a){var b=a[0],g=a[1];a=a[2];return y(b*b+g*g+a*a)},normSq:function(a){var b=a[0],g=a[1];a=a[2];return b*b+g*g+a*a},dot:function(a,b){return a[0]*b[0]+a[1]*b[1]+a[2]*b[2]},clone:function(a){return a.$$family?
new j(a[0],a[1],a[2]):j.setVec3(new i(3),a)},toFloat32Array:function(a){var b=a.typedContainer;if(!b)return a;b[0]=a[0];b[1]=a[1];b[2]=a[2];return b}},u=j.prototype,A;for(A in n){j[A]=n[A];u[A]=function(a){return function(){var b=h.call(arguments);b.unshift(this);return j[a].apply(j,b)}}(A)}var t=function(a,b,g,m,q,r,w,z,B,C,D,E,G,J,K,H){c.call(this,16);this.length=16;typeof a=="number"?this.set(a,b,g,m,q,r,w,z,B,C,D,E,G,J,K,H):this.id();this.typedContainer=new i(16)};t.create=function(){return new i(16)};
t.prototype=Object.create(c.prototype,{$$family:{value:"Mat4"},n11:x(0),n12:x(4),n13:x(8),n14:x(12),n21:x(1),n22:x(5),n23:x(9),n24:x(13),n31:x(2),n32:x(6),n33:x(10),n34:x(14),n41:x(3),n42:x(7),n43:x(11),n44:x(15)});n={id:function(a){a[0]=1;a[1]=0;a[2]=0;a[3]=0;a[4]=0;a[5]=1;a[6]=0;a[7]=0;a[8]=0;a[9]=0;a[10]=1;a[11]=0;a[12]=0;a[13]=0;a[14]=0;a[15]=1;return a},clone:function(a){return a.$$family?new t(a[0],a[4],a[8],a[12],a[1],a[5],a[9],a[13],a[2],a[6],a[10],a[14],a[3],a[7],a[11],a[15]):new i(a)},set:function(a,
b,g,m,q,r,w,z,B,C,D,E,G,J,K,H,F){a[0]=b;a[4]=g;a[8]=m;a[12]=q;a[1]=r;a[5]=w;a[9]=z;a[13]=B;a[2]=C;a[6]=D;a[10]=E;a[14]=G;a[3]=J;a[7]=K;a[11]=H;a[15]=F;return a},mulVec3:function(a,b){var g=j.clone(b);return t.$mulVec3(a,g)},$mulVec3:function(a,b){var g=b[0],m=b[1],q=b[2];b[0]=a[0]*g+a[4]*m+a[8]*q+a[12];b[1]=a[1]*g+a[5]*m+a[9]*q+a[13];b[2]=a[2]*g+a[6]*m+a[10]*q+a[14];return b},mulMat42:function(a,b,g){var m=b[0],q=b[1],r=b[2],w=b[3],z=b[4],B=b[5],C=b[6],D=b[7],E=b[8],G=b[9],J=b[10],K=b[11],H=b[12],
F=b[13],N=b[14];b=b[15];var L=g[0],M=g[1],P=g[2],Q=g[3],R=g[4],U=g[5],V=g[6],W=g[7],S=g[8],T=g[9],X=g[10],O=g[11],Y=g[12],Z=g[13],$=g[14];g=g[15];a[0]=L*m+M*z+P*E+Q*H;a[1]=L*q+M*B+P*G+Q*F;a[2]=L*r+M*C+P*J+Q*N;a[3]=L*w+M*D+P*K+Q*b;a[4]=R*m+U*z+V*E+W*H;a[5]=R*q+U*B+V*G+W*F;a[6]=R*r+U*C+V*J+W*N;a[7]=R*w+U*D+V*K+W*b;a[8]=S*m+T*z+X*E+O*H;a[9]=S*q+T*B+X*G+O*F;a[10]=S*r+T*C+X*J+O*N;a[11]=S*w+T*D+X*K+O*b;a[12]=Y*m+Z*z+$*E+g*H;a[13]=Y*q+Z*B+$*G+g*F;a[14]=Y*r+Z*C+$*J+g*N;a[15]=Y*w+Z*D+$*K+g*b;return a},mulMat4:function(a,
b){var g=t.clone(a);return t.mulMat42(g,a,b)},$mulMat4:function(a,b){return t.mulMat42(a,a,b)},add:function(a,b){var g=t.clone(a);return t.$add(g,b)},$add:function(a,b){a[0]+=b[0];a[1]+=b[1];a[2]+=b[2];a[3]+=b[3];a[4]+=b[4];a[5]+=b[5];a[6]+=b[6];a[7]+=b[7];a[8]+=b[8];a[9]+=b[9];a[10]+=b[10];a[11]+=b[11];a[12]+=b[12];a[13]+=b[13];a[14]+=b[14];a[15]+=b[15];return a},transpose:function(a){a=t.clone(a);return t.$transpose(a)},$transpose:function(a){var b=a[8],g=a[12],m=a[1],q=a[9],r=a[13],w=a[2],z=a[6],
B=a[14],C=a[3],D=a[7],E=a[11];a[1]=a[4];a[2]=b;a[3]=g;a[4]=m;a[6]=q;a[7]=r;a[8]=w;a[9]=z;a[11]=B;a[12]=C;a[13]=D;a[14]=E;return a},rotateAxis:function(a,b,g){a=t.clone(a);return t.$rotateAxis(a,b,g)},$rotateAxis:function(a,b,g){var m=p(b),q=k(b),r=1-q,w=g[0],z=g[1],B=g[2];g=w*w*r+q;b=w*z*r+B*m;var C=w*B*r-z*m,D=z*w*r-B*m,E=z*z*r+q,G=z*B*r+w*m,J=w*B*r+z*m;m=z*B*r-w*m;q=B*B*r+q;r=a[0];w=a[1];z=a[2];B=a[3];var K=a[4],H=a[5],F=a[6],N=a[7],L=a[8],M=a[9],P=a[10],Q=a[11];a[0]=r*g+K*b+L*C;a[1]=w*g+H*b+M*
C;a[2]=z*g+F*b+P*C;a[3]=B*g+N*b+Q*C;a[4]=r*D+K*E+L*G;a[5]=w*D+H*E+M*G;a[6]=z*D+F*E+P*G;a[7]=B*D+N*E+Q*G;a[8]=r*J+K*m+L*q;a[9]=w*J+H*m+M*q;a[10]=z*J+F*m+P*q;a[11]=B*J+N*m+Q*q;return a},rotateXYZ:function(a,b,g,m){a=t.clone(a);return t.$rotateXYZ(a,b,g,m)},$rotateXYZ:function(a,b,g,m){var q=a[0],r=a[1],w=a[2],z=a[3],B=a[4],C=a[5],D=a[6],E=a[7],G=a[8],J=a[9],K=a[10],H=a[11],F=k(b),N=k(g),L=k(m);b=p(b);var M=p(g),P=p(m);m=N*L;g=-F*P+b*M*L;var Q=b*P+F*M*L,R=N*P,U=F*L+b*M*P;L=-b*L+F*M*P;M=-M;b*=N;F*=N;
a[0]=q*m+B*R+G*M;a[1]=r*m+C*R+J*M;a[2]=w*m+D*R+K*M;a[3]=z*m+E*R+H*M;a[4]=q*g+B*U+G*b;a[5]=r*g+C*U+J*b;a[6]=w*g+D*U+K*b;a[7]=z*g+E*U+H*b;a[8]=q*Q+B*L+G*F;a[9]=r*Q+C*L+J*F;a[10]=w*Q+D*L+K*F;a[11]=z*Q+E*L+H*F;return a},translate:function(a,b,g,m){a=t.clone(a);return t.$translate(a,b,g,m)},$translate:function(a,b,g,m){a[12]=a[0]*b+a[4]*g+a[8]*m+a[12];a[13]=a[1]*b+a[5]*g+a[9]*m+a[13];a[14]=a[2]*b+a[6]*g+a[10]*m+a[14];a[15]=a[3]*b+a[7]*g+a[11]*m+a[15];return a},scale:function(a,b,g,m){a=t.clone(a);return t.$scale(a,
b,g,m)},$scale:function(a,b,g,m){a[0]*=b;a[1]*=b;a[2]*=b;a[3]*=b;a[4]*=g;a[5]*=g;a[6]*=g;a[7]*=g;a[8]*=m;a[9]*=m;a[10]*=m;a[11]*=m;return a},invert:function(a){a=t.clone(a);return t.$invert(a)},$invert:function(a){var b=a[0],g=a[1],m=a[2],q=a[3],r=a[4],w=a[5],z=a[6],B=a[7],C=a[8],D=a[9],E=a[10],G=a[11],J=a[12],K=a[13],H=a[14],F=a[15],N=b*w-g*r,L=b*z-m*r,M=b*B-q*r,P=g*z-m*w,Q=g*B-q*w,R=m*B-q*z,U=C*K-D*J,V=C*H-E*J,W=C*F-G*J,S=D*H-E*K,T=D*F-G*K,X=E*F-G*H,O=1/(N*X-L*T+M*S+P*W-Q*V+R*U);a[0]=(+w*X-z*T+
B*S)*O;a[1]=(-g*X+m*T-q*S)*O;a[2]=(+K*R-H*Q+F*P)*O;a[3]=(-D*R+E*Q-G*P)*O;a[4]=(-r*X+z*W-B*V)*O;a[5]=(+b*X-m*W+q*V)*O;a[6]=(-J*R+H*M-F*L)*O;a[7]=(+C*R-E*M+G*L)*O;a[8]=(+r*T-w*W+B*U)*O;a[9]=(-b*T+g*W-q*U)*O;a[10]=(+J*Q-K*M+F*N)*O;a[11]=(-C*Q+D*M-G*N)*O;a[12]=(-r*S+w*V-z*U)*O;a[13]=(+b*S-g*V+m*U)*O;a[14]=(-J*P+K*L-H*N)*O;a[15]=(+C*P-D*L+E*N)*O;return a},lookAt:function(a,b,g,m){g=j.sub(b,g);g.$unit();m=j.cross(m,g);m.$unit();var q=j.cross(g,m);q.$unit();return t.set(a,m[0],m[1],m[2],-m.dot(b),q[0],q[1],
q[2],-q.dot(b),g[0],g[1],g[2],-g.dot(b),0,0,0,1)},frustum:function(a,b,g,m,q,r,w){var z=g-b,B=q-m,C=w-r;a[0]=r*2/z;a[1]=0;a[2]=0;a[3]=0;a[4]=0;a[5]=r*2/B;a[6]=0;a[7]=0;a[8]=(g+b)/z;a[9]=(q+m)/B;a[10]=-(w+r)/C;a[11]=-1;a[12]=0;a[13]=0;a[14]=-(w*r*2)/C;a[15]=0;return a},perspective:function(a,b,g,m,q){b=m*f(b*d/360);var r=-b;return t.frustum(a,r*g,b*g,r,b,m,q)},ortho:function(a,b,g,m,q,r,w){var z=g-b,B=q-m,C=w-r;a[0]=2/z;a[1]=0;a[2]=0;a[3]=0;a[4]=0;a[5]=2/B;a[6]=0;a[7]=0;a[8]=0;a[9]=0;a[10]=-2/C;a[11]=
0;a[12]=-(b+g)/z;a[13]=-(q+m)/B;a[14]=-(w+r)/C;a[15]=1;return a},toFloat32Array:function(a){var b=a.typedContainer;if(!b)return a;b[0]=a[0];b[1]=a[1];b[2]=a[2];b[3]=a[3];b[4]=a[4];b[5]=a[5];b[6]=a[6];b[7]=a[7];b[8]=a[8];b[9]=a[9];b[10]=a[10];b[11]=a[11];b[12]=a[12];b[13]=a[13];b[14]=a[14];b[15]=a[15];return b}};u=t.prototype;for(A in n){t[A]=n[A];u[A]=function(a){return function(){var b=h.call(arguments);b.unshift(this);return t[a].apply(t,b)}}(A)}var v=function(a,b,g,m){c.call(this,4);this[0]=a||
0;this[1]=b||0;this[2]=g||0;this[3]=m||0;this.typedContainer=new i(4)};v.create=function(){return new i(4)};n={setQuat:function(a,b){a[0]=b[0];a[1]=b[1];a[2]=b[2];a[3]=b[3];return a},set:function(a,b,g,m,q){a[0]=b||0;a[1]=g||0;a[2]=m||0;a[3]=q||0;return a},clone:function(a){return a.$$family?new v(a[0],a[1],a[2],a[3]):v.setQuat(new i(4),a)},neg:function(a){return new v(-a[0],-a[1],-a[2],-a[3])},$neg:function(a){a[0]=-a[0];a[1]=-a[1];a[2]=-a[2];a[3]=-a[3];return a},add:function(a,b){return new v(a[0]+
b[0],a[1]+b[1],a[2]+b[2],a[3]+b[3])},$add:function(a,b){a[0]+=b[0];a[1]+=b[1];a[2]+=b[2];a[3]+=b[3];return a},sub:function(a,b){return new v(a[0]-b[0],a[1]-b[1],a[2]-b[2],a[3]-b[3])},$sub:function(a,b){a[0]-=b[0];a[1]-=b[1];a[2]-=b[2];a[3]-=b[3];return a},scale:function(a,b){return new v(a[0]*b,a[1]*b,a[2]*b,a[3]*b)},$scale:function(a,b){a[0]*=b;a[1]*=b;a[2]*=b;a[3]*=b;return a},mulQuat:function(a,b){var g=a[0],m=a[1],q=a[2],r=a[3],w=b[0],z=b[1],B=b[2],C=b[3];return new v(r*w+g*C+m*B-q*z,r*z+m*C+
q*w-g*B,r*B+q*C+g*z-m*w,r*C-g*w-m*z-q*B)},$mulQuat:function(a,b){var g=a[0],m=a[1],q=a[2],r=a[3],w=b[0],z=b[1],B=b[2],C=b[3];a[0]=r*w+g*C+m*B-q*z;a[1]=r*z+m*C+q*w-g*B;a[2]=r*B+q*C+g*z-m*w;a[3]=r*C-g*w-m*z-q*B;return a},divQuat:function(a,b){var g=a[0],m=a[1],q=a[2],r=a[3],w=b[0],z=b[1],B=b[2],C=b[3],D=1/(C*C+w*w+z*z+B*B);return new v((g*C-r*w-m*B+q*z)*D,(g*B-r*z+m*C-q*w)*D,(m*w+q*C-r*B-g*z)*D,(r*C+g*w+m*z+q*B)*D)},$divQuat:function(a,b){var g=a[0],m=a[1],q=a[2],r=a[3],w=b[0],z=b[1],B=b[2],C=b[3],
D=1/(C*C+w*w+z*z+B*B);a[0]=(g*C-r*w-m*B+q*z)*D;a[1]=(g*B-r*z+m*C-q*w)*D;a[2]=(m*w+q*C-r*B-g*z)*D;a[3]=(r*C+g*w+m*z+q*B)*D;return a},invert:function(a){var b=a[0],g=a[1],m=a[2];a=a[3];var q=1/(b*b+g*g+m*m+a*a);return new v(-b*q,-g*q,-m*q,a*q)},$invert:function(a){var b=a[0],g=a[1],m=a[2],q=a[3],r=1/(b*b+g*g+m*m+q*q);a[0]=-b*r;a[1]=-g*r;a[2]=-m*r;a[3]=q*r;return a},norm:function(a){var b=a[0],g=a[1],m=a[2];a=a[3];return y(b*b+g*g+m*m+a*a)},normSq:function(a){var b=a[0],g=a[1],m=a[2];a=a[3];return b*
b+g*g+m*m+a*a},unit:function(a){return v.scale(a,1/v.norm(a))},$unit:function(a){return v.$scale(a,1/v.norm(a))},conjugate:function(a){return new v(-a[0],-a[1],-a[2],a[3])},$conjugate:function(a){a[0]=-a[0];a[1]=-a[1];a[2]=-a[2];return a}};u=v.prototype={};for(A in n){v[A]=n[A];u[A]=function(a){return function(){var b=h.call(arguments);b.unshift(this);return v[a].apply(v,b)}}(A)}j.fromQuat=function(a){return new j(a[0],a[1],a[2])};v.fromVec3=function(a,b){return new v(a[0],a[1],a[2],b||0)};v.fromMat4=
function(a){var b,g,m;if(a[0]>a[5]&&a[0]>a[10]){b=0;g=1;m=2}else if(a[5]>a[0]&&a[5]>a[10]){b=1;g=2;m=0}else{b=2;g=0;m=1}var q=y(1+a[b*5]-a[g*5]-a[m*5]),r=new v;r[b]=0.5*q;r[g]=0.5*(a["n"+g+""+b]+a["n"+b+""+g])/q;r[m]=0.5*(a["n"+b+""+m]+a["n"+m+""+b])/q;r[3]=0.5*(a["n"+g+""+m]-a["n"+m+""+g])/q;return r};v.fromXRotation=function(a){return new v(p(a/2),0,0,k(a/2))};v.fromYRotation=function(a){return new v(0,p(a/2),0,k(a/2))};v.fromZRotation=function(a){return new v(0,0,p(a/2),k(a/2))};v.fromAxisRotation=
function(a,b){var g=a[0],m=a[1],q=a[2],r=1/y(g*g+m*m+q*q),w=p(b/2),z=k(b/2);return new v(w*g*r,w*m*r,w*q*r,z)};t.fromQuat=function(a){var b=a[3],g=a[0],m=a[1];a=a[2];return new t(b*b+g*g-m*m-a*a,2*g*m-2*b*a,2*g*a+2*b*m,0,2*g*m+2*b*a,b*b-g*g+m*m-a*a,2*m*a-2*b*g,0,2*g*a-2*b*m,2*m*a+2*b*g,b*b-g*g-m*m+a*a,0,0,0,0,1)};PhiloGL.Vec3=j;PhiloGL.Mat4=t;PhiloGL.Quat=v})();(function(){function x(d){return d!==true?d:false}var y=function(d){d=d.getBoundingClientRect();return{x:d.left,y:d.top,bbox:d}},p={get:function(d,
h){return d||(h||window).event},getWheel:function(d){return d.wheelDelta?d.wheelDelta/120:-(d.detail||0)/3},getKey:function(d){var h=d.which||d.keyCode,i;a:{i=f.Keys;for(var c in i)if(i[c]==h){i=c;break a}i=void 0}c=h-111;if(c>0&&c<13)i="f"+c;i=i||String.fromCharCode(h).toLowerCase();return{code:h,key:i,shift:d.shiftKey,control:d.ctrlKey,alt:d.altKey,meta:d.metaKey}},isRightClick:function(d){return d.which==3||d.button==2},getPos:function(d,h){h=h||window;d=d||h.event;var i=h.document;i=i.documentElement||
i.body;if(d.touches&&d.touches.length)d=d.touches[0];return{x:d.pageX||d.clientX+i.scrollLeft,y:d.pageY||d.clientY+i.scrollTop}},stop:function(d){d.stopPropagation&&d.stopPropagation();d.cancelBubble=true;if(d.preventDefault)d.preventDefault();else d.returnValue=false}},k=function(d,h){var i=d.canvas;this.scene=d.scene;this.domElem=i;this.pos=y(i);this.opt=this.callbacks=h;this.size={width:i.width||i.offsetWidth,height:i.height||i.offsetHeight};this.attachEvents()};k.prototype={hovered:false,pressed:false,
touched:false,touchMoved:false,moved:false,attachEvents:function(){var d=this.domElem,h=this;if(this.opt.disableContextMenu)d.oncontextmenu=function(){return false};["mouseup","mousedown","mousemove","mouseover","mouseout","touchstart","touchmove","touchend"].forEach(function(c){d.addEventListener(c,function(l,j){h[c](h.eventInfo(c,l,j))},false)});["keydown","keyup"].forEach(function(c){document.addEventListener(c,function(l,j){h[c](h.eventInfo(c,l,j))},false)});var i="";i=!document.getBoxObjectFor&&
window.mozInnerScreenX==null?"mousewheel":"DOMMouseScroll";d.addEventListener(i,function(c,l){h.mousewheel(h.eventInfo("mousewheel",c,l))},false)},eventInfo:function(d,h,i){var c=this.domElem,l=this.scene,j=this.opt,n=this.getSize(),u=j.relative,A=j.centerOrigin,t=j.cachePosition&&this.pos||y(c),v=p.get(h,i),a=p.getPos(h,i);h={};i=a.x;c=a.y;if(u){i-=t.x;c-=t.y;if(A){i-=n.width/2;c-=n.height/2;c*=-1}}switch(d){case "mousewheel":h.wheel=p.getWheel(v);break;case "keydown":s.extend(h,p.getKey(v));break;
case "mouseup":h.isRightClick=p.isRightClick(v)}var b;s.extend(h,{x:i,y:c,cache:false,stop:function(){p.stop(v)},getTarget:function(){if(b)return b;return b=!j.picking||l.pick(a.x-t.x,a.y-t.y,j.lazyPicking)||true}});h.event=v;return h},getSize:function(){if(this.cacheSize)return this.size;var d=this.domElem;return{width:d.width||d.offsetWidth,height:d.height||d.offsetHeight}},mouseup:function(d){if(!this.moved)if(d.isRightClick)this.callbacks.onRightClick(d,this.hovered);else this.callbacks.onClick(d,
x(this.pressed));if(this.pressed){if(this.moved)this.callbacks.onDragEnd(d,x(this.pressed));else this.callbacks.onDragCancel(d,x(this.pressed));this.pressed=this.moved=false}},mouseout:function(d){for(var h=d.relatedTarget,i=this.domElem;h&&h.parentNode;){if(i==h.parentNode)return;h=h.parentNode}if(this.hovered){this.callbacks.onMouseLeave(d,this.hovered);this.hovered=false}if(this.pressed&&this.moved){this.callbacks.onDragEnd(d);this.pressed=this.moved=false}},mouseover:function(){},mousemove:function(d){if(this.pressed){this.moved=
true;this.callbacks.onDragMove(d,x(this.pressed))}else{if(this.hovered){var h=x(d.getTarget());if(!h||h.id!=this.hovered.id){this.callbacks.onMouseLeave(d,this.hovered);if(this.hovered=h)this.callbacks.onMouseEnter(d,this.hovered)}else this.callbacks.onMouseMove(d,this.hovered)}else if(this.hovered=x(d.getTarget()))this.callbacks.onMouseEnter(d,this.hovered);if(!this.opt.picking)this.callbacks.onMouseMove(d)}},mousewheel:function(d){this.callbacks.onMouseWheel(d)},mousedown:function(d){this.pressed=
d.getTarget();this.callbacks.onDragStart(d,x(this.pressed))},touchstart:function(d){this.touched=d.getTarget();this.callbacks.onTouchStart(d,x(this.touched))},touchmove:function(d){if(this.touched){this.touchMoved=true;this.callbacks.onTouchMove(d,x(this.touched))}},touchend:function(d){if(this.touched){if(this.touchMoved)this.callbacks.onTouchEnd(d,x(this.touched));else this.callbacks.onTouchCancel(d,x(this.touched));this.touched=this.touchMoved=false}},keydown:function(d){this.callbacks.onKeyDown(d)},
keyup:function(d){this.callbacks.onKeyUp(d)}};var f={};f.create=function(d,h){h=s.extend({cachePosition:true,cacheSize:true,relative:true,centerOrigin:true,disableContextMenu:true,bind:false,picking:false,lazyPicking:false,onClick:s.empty,onRightClick:s.empty,onDragStart:s.empty,onDragMove:s.empty,onDragEnd:s.empty,onDragCancel:s.empty,onTouchStart:s.empty,onTouchMove:s.empty,onTouchEnd:s.empty,onTouchCancel:s.empty,onMouseMove:s.empty,onMouseEnter:s.empty,onMouseLeave:s.empty,onMouseWheel:s.empty,
onKeyDown:s.empty,onKeyUp:s.empty},h||{});var i=h.bind;if(i)for(var c in h)c.match(/^on[a-zA-Z0-9]+$/)&&function(l,j){h[l]=function(){return j.apply(i,Array.prototype.slice.call(arguments))}}(c,h[c]);new k(d,h);d.events=h};f.Keys={enter:13,up:38,down:40,left:37,right:39,esc:27,space:32,backspace:8,tab:9,"delete":46};PhiloGL.Events=f})();(function(){function x(){return arguments.length==2?{vs:arguments[0],fs:arguments[1]}:arguments[0]||{}}var y=function(f,d,h){var i=f.createShader(h);if(i==null)throw"Error creating the shader with shader type: "+
h;f.shaderSource(i,d);f.compileShader(i);if(!f.getShaderParameter(i,f.COMPILE_STATUS)){d=f.getShaderInfoLog(i);f.deleteShader(i);throw"Error while compiling the shader "+d;}return i},p=function(f,d,h){var i=o.getUniformLocation(f,d.name);f=d.type;var c=false,l=true,j,n;if(d.size>1&&h)switch(f){case o.FLOAT:j=o.uniform1fv;n=Float32Array;l=false;break;case o.INT:case o.BOOL:case o.SAMPLER_2D:case o.SAMPLER_CUBE:j=o.uniform1iv;n=Uint16Array;l=false}if(l)switch(f){case o.FLOAT:j=o.uniform1f;break;case o.FLOAT_VEC2:j=
o.uniform2fv;n=h?Float32Array:new Float32Array(2);break;case o.FLOAT_VEC3:j=o.uniform3fv;n=h?Float32Array:new Float32Array(3);break;case o.FLOAT_VEC4:j=o.uniform4fv;n=h?Float32Array:new Float32Array(4);break;case o.INT:case o.BOOL:case o.SAMPLER_2D:case o.SAMPLER_CUBE:j=o.uniform1i;break;case o.INT_VEC2:case o.BOOL_VEC2:j=o.uniform2iv;n=h?Uint16Array:new Uint16Array(2);break;case o.INT_VEC3:case o.BOOL_VEC3:j=o.uniform3iv;n=h?Uint16Array:new Uint16Array(3);break;case o.INT_VEC4:case o.BOOL_VEC4:j=
o.uniform4iv;n=h?Uint16Array:new Uint16Array(4);break;case o.FLOAT_MAT2:c=true;j=o.uniformMatrix2fv;break;case o.FLOAT_MAT3:c=true;j=o.uniformMatrix3fv;break;case o.FLOAT_MAT4:c=true;j=o.uniformMatrix4fv}if(j.bind)j=j.bind(o);else{var u=j;j=function(){u.apply(o,arguments)}}return h?function(A){j(i,new n(A))}:c?function(A){j(i,false,A.toFloat32Array())}:n?function(A){n.set(A);j(i,n)}:function(A){j(i,A)};throw"Unknown type: "+f;},k=function(f,d){var h=o,i=h.createProgram();h.attachShader(i,y(h,f,h.VERTEX_SHADER));
h.attachShader(i,y(h,d,h.FRAGMENT_SHADER));h.linkProgram(i);if(!h.getProgramParameter(i,h.LINK_STATUS))throw"Error linking the shader: "+h.getProgramInfoLog(i);if(!i)return false;h={};for(var c={},l,j,n=o.getProgramParameter(i,o.ACTIVE_ATTRIBUTES),u=0;u<n;u++){l=o.getActiveAttrib(i,u);j=l.name;l=o.getAttribLocation(i,l.name);h[j]=l}n=o.getProgramParameter(i,o.ACTIVE_UNIFORMS);for(u=0;u<n;u++){l=o.getActiveUniform(i,u);j=l.name;j=j[j.length-1]=="]"?j.substr(0,j.length-3):j;c[j]=p(i,l,l.name!=j)}this.program=
i;this.attributes=h;this.attributeEnabled={};this.uniforms=c};k.prototype={$$family:"program",setUniform:function(f,d){if(this.uniforms[f])this.uniforms[f](d);return this},setUniforms:function(f){for(var d in f)this.setUniform(d,f[d]);return this}};["setBuffer","setBuffers","use"].forEach(function(f){k.prototype[f]=function(){var d=Array.prototype.slice.call(arguments);d.unshift(this);I[f].apply(I,d);return this}});["setFrameBuffer","setFrameBuffers","setRenderBuffer","setRenderBuffers","setTexture",
"setTextures"].forEach(function(f){k.prototype[f]=function(){I[f].apply(I,arguments);return this}});k.fromShaderIds=function(){var f=x.apply({},arguments),d=s(f.vs);f=s(f.fs);return new k(d.innerHTML,f.innerHTML)};k.fromShaderSources=function(){var f=x.apply({},arguments);return new k(f.vs,f.fs)};k.fromDefaultShaders=function(){var f=x.apply({},arguments),d=PhiloGL.Shaders;return PhiloGL.Program.fromShaderSources(d.Vertex[f.vs||"Default"],d.Fragment[f.fs||"Default"])};k.fromShaderURIs=function(f){f=
s.merge({path:"",vs:"",fs:"",noCache:false,onSuccess:s.empty,onError:s.empty},f||{});(new PhiloGL.IO.XHR.Group({urls:[f.path+f.vs,f.path+f.fs],noCache:f.noCache,onError:function(d){f.onError(d)},onComplete:function(d){try{var h=k.fromShaderSources(d[0],d[1]);f.onSuccess(h,f)}catch(i){f.onError(i,f)}}})).send()};PhiloGL.Program=k})();(function(){var x={},y=function(f){this.opt=f=s.merge({url:"http://philogljs.org/",method:"GET",async:true,noCache:false,sendAsBinary:false,responseType:false,onProgress:s.empty,
onSuccess:s.empty,onError:s.empty,onAbort:s.empty,onComplete:s.empty},f||{});this.initXHR()};y.State={};["UNINITIALIZED","LOADING","LOADED","INTERACTIVE","COMPLETED"].forEach(function(f,d){y.State[f]=d});y.prototype={initXHR:function(){var f=this.req=new XMLHttpRequest,d=this;["Progress","Error","Abort","Load"].forEach(function(h){if(f.addEventListener)f.addEventListener(h.toLowerCase(),function(i){d["handle"+h](i)},false);else f["on"+h.toLowerCase()]=function(i){d["handle"+h](i)}})},send:function(f){var d=
this.req,h=this.opt,i=h.async;if(h.noCache)h.url+=(h.url.indexOf("?")>=0?"&":"?")+s.uid();d.open(h.method,h.url,i);if(h.responseType)d.responseType=h.responseType;if(i)d.onreadystatechange=function(){if(d.readyState==y.State.COMPLETED)if(d.status==200)h.onSuccess(d.responseType?d.response:d.responseText);else h.onError(d.status)};h.sendAsBinary?d.sendAsBinary(f||h.body||null):d.send(f||h.body||null);if(!i)if(d.status==200)h.onSuccess(d.responseType?d.response:d.responseText);else h.onError(d.status)},
setRequestHeader:function(f,d){this.req.setRequestHeader(f,d);return this},handleProgress:function(f){if(f.lengthComputable)this.opt.onProgress(f,Math.round(f.loaded/f.total*100));else this.opt.onProgress(f,-1)},handleError:function(f){this.opt.onError(f)},handleAbort:function(){this.opt.onAbort(e)},handleLoad:function(f){this.opt.onComplete(f)}};y.Group=function(f){function d(j){return function(n){--c;f.onError(n,j);if(!c)f.onComplete(l)}}function h(j){return function(n){--c;l[j]=n;f.onSuccess(n,
j);if(!c)f.onComplete(l)}}f=s.merge({urls:[],onError:s.empty,onSuccess:s.empty,onComplete:s.empty,method:"GET",async:true,noCache:false,sendAsBinary:false,responseType:false},f||{});var i=s.splat(f.urls),c=i.length,l=Array(c);this.reqs=i.map(function(j,n){return new y({url:j,method:f.method,async:f.async,noCache:f.noCache,sendAsBinary:f.sendAsBinary,responseType:f.responseType,body:f.body,onError:d(n),onSuccess:h(n)})})};y.Group.prototype={send:function(){for(var f=0,d=this.reqs,h=d.length;f<h;++f)d[f].send()}};
var p=function(f){f=s.merge({url:"http://philogljs.org/",data:{},noCache:false,onComplete:s.empty,callbackKey:"callback"},f||{});var d=p.counter++,h=[],i;for(i in f.data)h.push(i+"="+f.data[i]);h=h.join("&");if(f.noCache)h+=(h.indexOf("?")>=0?"&":"?")+s.uid();h=f.url+(f.url.indexOf("?")>-1?"&":"?")+f.callbackKey+"=PhiloGL.IO.JSONP.requests.request_"+d+(h.length>0?"&"+h:"");var c=document.createElement("script");c.type="text/javascript";c.src=h;p.requests["request_"+d]=function(l){f.onComplete(l);
c.parentNode&&c.parentNode.removeChild(c);c.clearAttributes&&c.clearAttributes()};document.getElementsByTagName("head")[0].appendChild(c)};p.counter=0;p.requests={};var k=function(f){f=s.merge({src:[],noCache:false,onProgress:s.empty,onComplete:s.empty},f||{});var d=0,h=f.src.length,i=function(){f.onProgress(Math.round(++d/h*100));if(d==h)f.onComplete(n)},c=function(){if(++d==h)f.onComplete(n)},l=f.noCache,j=s.uid(),n=f.src.map(function(u,A){var t=new Image;t.index=A;t.onload=i;t.onerror=c;t.src=
u+(l?(u.indexOf("?")>=0?"&":"?")+j:"");return t});return n};x.XHR=y;x.JSONP=p;x.Images=k;x.Textures=function(f){f=s.merge({src:[],noCache:false,onComplete:s.empty},f||{});k({src:f.src,noCache:f.noCache,onComplete:function(d){var h={};d.forEach(function(i,c){h[f.src[c]]=s.merge({data:{value:i}},f)});I.setTextures(h);f.onComplete()}})};PhiloGL.IO=x})();(function(){var x=PhiloGL.Vec3,y=PhiloGL.Mat4,p=function(k,f,d,h,i){i=i||{};var c=i.position,l=i.target,j=i.up;this.type=i.type?i.type:"perspective";
this.fov=k;this.near=d;this.far=h;this.aspect=f;this.position=c&&new x(c.x,c.y,c.z)||new x;this.target=l&&new x(l.x,l.y,l.z)||new x;this.up=j&&new x(j.x,j.y,j.z)||new x(0,1,0);if(this.type=="perspective")this.projection=(new y).perspective(k,f,d,h);else{k=d*Math.tan(k*Math.PI/360);i=-k;this.projection=(new y).ortho(i*f,k*f,i,k,d,h)}this.view=new y};p.prototype={update:function(){if(this.type=="perspective")this.projection=(new y).perspective(this.fov,this.aspect,this.near,this.far);else{var k=this.near*
Math.tan(this.fov*Math.PI/360),f=-k,d=f*this.aspect,h=k*this.aspect;this.projection=(new y).ortho(d,h,f,k,this.near,this.far)}this.view.lookAt(this.position,this.target,this.up)}};PhiloGL.Camera=p})();(function(){function x(c,l){if(c&&c.length<l){for(var j=c[0],n=c[1],u=c[2],A=c[3],t=[j,n,u,A],v=l/c.length,a;--v;){a=v*4;t[a]=j;t[a+1]=n;t[a+2]=u;t[a+3]=A}return new Float32Array(t)}else return c}var y=PhiloGL.Vec3,p=PhiloGL.Mat4,k=Math.cos,f=Math.sin,d=Math.PI,h=Array.prototype.slice,i={attributeMap:{position:"vertices",
normal:"normals",pickingColor:"pickingColors",colors:"color"}};i.Model=function(c){c=c||{};this.id=c.id||s.uid();this.pickable=!!c.pickable;this.pick=c.pick||function(){return false};this.vertices=c.vertices;this.normals=c.normals;this.textures=c.textures&&s.splat(c.textures);this.colors=c.colors;this.indices=c.indices;this.shininess=c.shininess||0;this.reflection=c.reflection||0;this.refraction=c.refraction||0;if(c.pickingColors)this.pickingColors=c.pickingColors;if(c.texCoords)this.texCoords=c.texCoords;
this.uniforms=c.uniforms||{};this.attributes=c.attributes||{};this.render=c.render;this.drawType=c.drawType||"TRIANGLES";this.display="display"in c?c.display:true;this.onBeforeRender=c.onBeforeRender||s.empty;this.onAfterRender=c.onAfterRender||s.empty;if(c.program)this.program=c.program;this.position=new y;this.rotation=new y;this.scale=new y(1,1,1);this.matrix=new p;c.computeCentroids&&this.computeCentroids();c.computeNormals&&this.computeNormals()};i.Model.prototype=Object.create(null,{vertices:{set:function(c){if(c){var l=
c.length;if(c.BYTES_PER_ELEMENT)this.$vertices=c;else if(this.$verticesLength==l)this.$vertices.set(c);else this.$vertices=new Float32Array(c);this.$verticesLength=l}else{delete this.$vertices;delete this.$verticesLength}},get:function(){return this.$vertices}},normals:{set:function(c){if(c){var l=c.length;if(c.BYTES_PER_ELEMENT)this.$normals=c;else if(this.$normalsLength==l)this.$normals.set(c);else this.$normals=new Float32Array(c);this.$normalsLength=l}else{delete this.$normals;delete this.$normalsLength}},
get:function(){return this.$normals}},colors:{set:function(c){if(c){var l=c.length;if(c.BYTES_PER_ELEMENT)this.$colors=c;else if(this.$colorsLength==l)this.$colors.set(c);else this.$colors=new Float32Array(c);if(this.$vertices&&this.$verticesLength/3*4!=l)this.$colors=x(h.call(this.$colors),this.$verticesLength/3*4);this.$colorsLength=this.$colors.length}else{delete this.$colors;delete this.$colorsLength}},get:function(){return this.$colors}},pickingColors:{set:function(c){if(c){var l=c.length;if(c.BYTES_PER_ELEMENT)this.$pickingColors=
c;else if(this.$pickingColorsLength==l)this.$pickingColors.set(c);else this.$pickingColors=new Float32Array(c);if(this.$vertices&&this.$verticesLength/3*4!=l)this.$pickingColors=x(h.call(this.$pickingColors),this.$verticesLength/3*4);this.$pickingColorsLength=this.$pickingColors.length}else{delete this.$pickingColors;delete this.$pickingColorsLength}},get:function(){return this.$pickingColors}},texCoords:{set:function(c){if(c)if(s.type(c)=="object"){var l={},j;for(j in c){var n=c[j];l[j]=n.BYTES_PER_ELEMENT?
n:new Float32Array(n)}this.$texCoords=l}else{l=c.length;if(c.BYTES_PER_ELEMENT)this.$texCoords=c;else if(this.$texCoordsLength==l)this.$texCoords.set(c);else this.$texCoords=new Float32Array(c);this.$texCoordsLength=l}else{delete this.$texCoords;delete this.$texCoordsLength}},get:function(){return this.$texCoords}},indices:{set:function(c){if(c){var l=c.length;if(c.BYTES_PER_ELEMENT)this.$indices=c;else if(this.$indicesLength==l)this.$indices.set(c);else this.$indices=new Uint16Array(c);this.$indicesLength=
l}else{delete this.$indices;delete this.$indicesLength}},get:function(){return this.$indices}}});s.extend(i.Model.prototype,{$$family:"model",update:function(){var c=this.matrix,l=this.position,j=this.rotation,n=this.scale;c.id();c.$translate(l.x,l.y,l.z);c.$rotateXYZ(j.x,j.y,j.z);c.$scale(n.x,n.y,n.z)},computeCentroids:function(){var c=this.vertices,l=[];this.faces.forEach(function(j){var n=[0,0,0],u=0;j.forEach(function(A){A=c[A];n[0]+=A[0];n[1]+=A[1];n[2]+=A[2];u++});n[0]/=u;n[1]/=u;n[2]/=u;l.push(n)});
this.centroids=l},computeNormals:function(){var c=this.vertices,l=[];this.faces.forEach(function(j){var n=c[j[0]],u=c[j[1]];j=c[j[2]];n={x:n[0]-u[0],y:n[1]-u[1],z:n[2]-u[2]};y.$cross(n,{x:j[0]-u[0],y:j[1]-u[1],z:j[1]-u[2]});y.norm(n)>1.0E-6&&y.unit(n);l.push([n.x,n.y,n.z])});this.normals=l}});s.extend(i.Model.prototype,{setUniforms:function(c){c.setUniforms(this.uniforms)},setAttributes:function(c){var l=this.attributes,j;for(j in l){var n=l[j],u=this.id+"-"+j;if(Object.keys(n).length){n.attribute=
j;c.setBuffer(u,n);delete n.value}else c.setBuffer(u,true)}},setVertices:function(c){if(this.$vertices)this.dynamic?c.setBuffer("position-"+this.id,{attribute:"position",value:this.$vertices,size:3}):c.setBuffer("position-"+this.id)},setNormals:function(c){if(this.$normals)this.dynamic?c.setBuffer("normal-"+this.id,{attribute:"normal",value:this.$normals,size:3}):c.setBuffer("normal-"+this.id)},setIndices:function(c){if(this.$indices)this.dynamic?c.setBuffer("indices-"+this.id,{bufferType:o.ELEMENT_ARRAY_BUFFER,
drawType:o.STATIC_DRAW,value:this.$indices,size:1}):c.setBuffer("indices-"+this.id)},setPickingColors:function(c){if(this.$pickingColors)this.dynamic?c.setBuffer("pickingColor-"+this.id,{attribute:"pickingColor",value:this.$pickingColors,size:4}):c.setBuffer("pickingColor-"+this.id)},setColors:function(c){if(this.$colors)this.dynamic?c.setBuffer("color-"+this.id,{attribute:"color",value:this.$colors,size:4}):c.setBuffer("color-"+this.id)},setTexCoords:function(c){if(this.$texCoords){var l=this.id,
j,n,u,A;if(this.dynamic)if(s.type(this.$texCoords)=="object"){j=0;n=this.textures;for(u=n.length;j<u;j++){A=n[j];c.setBuffer("texCoord-"+j+"-"+l,{attribute:"texCoord"+(j+1),value:this.$texCoords[A],size:2})}}else c.setBuffer("texCoord-"+l,{attribute:"texCoord1",value:this.$texCoords,size:2});else if(s.type(this.$texCoords)=="object"){j=0;n=this.textures;for(u=n.length;j<u;j++)c.setBuffer("texCoord-"+j+"-"+l)}else c.setBuffer("texCoord-"+l)}},setTextures:function(c){this.textures=this.textures?s.splat(this.textures):
[];for(var l=0,j=this.textures,n=j.length,u=PhiloGL.Scene.MAX_TEXTURES;l<u;l++){if(l<n)if(I.textureMemo[j[l]].isCube){c.setUniform("hasTextureCube"+(l+1),true);c.setTexture(j[l],o["TEXTURE"+(l+5)])}else{c.setUniform("hasTexture"+(l+1),true);c.setTexture(j[l],o["TEXTURE"+l])}else{c.setUniform("hasTextureCube"+(l+1),false);c.setUniform("hasTexture"+(l+1),false)}c.setUniform("sampler"+(l+1),l);c.setUniform("samplerCube"+(l+1),l+5)}},setState:function(c){this.setUniforms(c);this.setAttributes(c);this.setVertices(c);
this.setColors(c);this.setPickingColors(c);this.setNormals(c);this.setTextures(c);this.setTexCoords(c);this.setIndices(c)},unsetState:function(c){c=c.attributes;o.bindBuffer(o.ARRAY_BUFFER,null);o.bindBuffer(o.ELEMENT_ARRAY_BUFFER,null);for(var l in c)o.disableVertexAttribArray(c[l])}});i.Cube=function(c){i.Model.call(this,s.extend({vertices:[-1,-1,1,1,-1,1,1,1,1,-1,1,1,-1,-1,-1,-1,1,-1,1,1,-1,1,-1,-1,-1,1,-1,-1,1,1,1,1,1,1,1,-1,-1,-1,-1,1,-1,-1,1,-1,1,-1,-1,1,1,-1,-1,1,1,-1,1,1,1,1,-1,1,-1,-1,-1,
-1,-1,1,-1,1,1,-1,1,-1],texCoords:[0,0,1,0,1,1,0,1,1,0,1,1,0,1,0,0,0,1,0,0,1,0,1,1,1,1,0,1,0,0,1,0,1,0,1,1,0,1,0,0,0,0,1,0,1,1,0,1],normals:[0,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0],indices:[0,1,2,0,2,3,4,5,6,4,6,7,8,9,10,8,10,11,12,13,14,12,14,15,16,17,18,16,18,19,20,21,22,20,22,23]},c||{}))};i.Cube.prototype=Object.create(i.Model.prototype);i.Sphere=function(c){var l=c.nlat||10,j=
c.nlong||10,n=c.radius||1,u=d-0,A=2*d-0,t=(l+1)*(j+1),v=new Float32Array(t*3),a=new Float32Array(t*3);t=new Float32Array(t*2);var b=new Uint16Array(l*j*6);if(typeof n=="number"){var g=n;n=function(){return g}}for(var m=0;m<=l;m++)for(var q=0;q<=j;q++){var r=q/j,w=m/l,z=A*r,B=u*w,C=f(z);z=k(z);var D=f(B),E=k(B);B=z*D;z=E;C*=D;D=n(B,z,C,r,w);E=q+m*(j+1);var G=E*3;E*=2;v[G+0]=D*B;v[G+1]=D*z;v[G+2]=D*C;a[G+0]=B;a[G+1]=z;a[G+2]=C;t[E+0]=r;t[E+1]=w}n=l+1;for(q=0;q<l;q++)for(m=0;m<j;m++){E=(q*j+m)*6;b[E+
0]=m*n+q;b[E+1]=m*n+q+1;b[E+2]=(m+1)*n+q;b[E+3]=(m+1)*n+q;b[E+4]=m*n+q+1;b[E+5]=(m+1)*n+q+1}i.Model.call(this,s.extend({vertices:v,indices:b,normals:a,texCoords:t},c||{}))};i.Sphere.prototype=Object.create(i.Model.prototype);i.IcoSphere=function(c){var l=c.iterations||0,j=[],n=[],u=Math.sqrt,A=Math.acos,t=Math.atan2,v=Math.PI,a=v*2;c.onAddVertex=c.onAddVertex||s.empty;var b=(1+u(5))/2,g=u(1+b*b);j.push(-1/g,b/g,0,1/g,b/g,0,-1/g,-b/g,0,1/g,-b/g,0,0,-1/g,b/g,0,1/g,b/g,0,-1/g,-b/g,0,1/g,-b/g,b/g,0,-1/
g,b/g,0,1/g,-b/g,0,-1/g,-b/g,0,1/g);n.push(0,11,5,0,5,1,0,1,7,0,7,10,0,10,11,1,5,9,5,11,4,11,10,2,10,7,6,7,1,8,3,9,4,3,4,2,3,2,6,3,6,8,3,8,9,4,9,5,2,4,11,6,2,10,8,6,7,9,8,1);var m=function(){var W={};return function(S,T){S*=3;T*=3;var X=(S<T?S:T)+"|"+(S>T?S:T);if(X in W)return W[X];var O=(j[S]+j[T])/2,Y=(j[S+1]+j[T+1])/2,Z=(j[S+2]+j[T+2])/2,$=u(O*O+Y*Y+Z*Z);O/=$;Y/=$;Z/=$;j.push(O,Y,Z);return W[X]=j.length/3-1}}();for(b=0;b<l;b++){var q=[],r=0;for(g=n.length;r<g;r+=3){var w=m(n[r],n[r+1]),z=m(n[r+
1],n[r+2]),B=m(n[r+2],n[r]);q.push(n[r],w,B,n[r+1],z,w,n[r+2],B,z,w,z,B)}n=q}g=n.length;l=new Float32Array(g*3);m=new Float32Array(g*2);for(b=0;b<g;b+=3){z=n[b];B=n[b+1];var C=n[b+2];q=z*3;r=B*3;w=C*3;z*=2;B*=2;C*=2;var D=j[q],E=j[q+1],G=j[q+2],J=A(G/u(D*D+E*E+G*G)),K=t(E,D);J/=v;K=1-K/a;var H=j[r],F=j[r+1],N=j[r+2],L=A(N/u(H*H+F*F+N*N)),M=t(F,H);L/=v;M=1-M/a;var P=j[w],Q=j[w+1],R=j[w+2],U=A(R/u(P*P+Q*Q+R*R)),V=t(Q,P);U/=v;V=1-V/a;D=y.cross({x:P-H,y:Q-F,z:R-N},{x:D-H,y:E-F,z:G-N}).$unit();l[q]=l[r]=
l[w]=D.x;l[q+1]=l[r+1]=l[w+1]=D.y;l[q+2]=l[r+2]=l[w+2]=D.z;m[z]=K;m[z+1]=J;m[B]=M;m[B+1]=L;m[C]=V;m[C+1]=U}i.Model.call(this,s.extend({vertices:j,indices:n,normals:l,texCoords:m},c||{}))};i.IcoSphere.prototype=Object.create(i.Model.prototype);i.TruncatedCone=function(c){var l=c.bottomRadius||0,j=c.topRadius||0,n=c.height||1,u=c.nradial||10,A=c.nvertical||10,t=!!c.topCap,v=!!c.bottomCap,a=(t?2:0)+(v?2:0),b=(u+1)*(A+1+a),g=new Float32Array(b*3),m=new Float32Array(b*3);b=new Float32Array(b*2);var q=
new Uint16Array(u*(A+a)*6),r=u+1,w=Math,z=w.atan2(l-j,n),B=w.sin,C=w.cos;w=w.PI;var D=C(z);z=B(z);v=A+(v?2:0);var E=0,G=0;for(t=t?-2:0;t<=v;t++){var J=t/A,K=n*J,H;if(t<0){K=0;J=1;H=l}else if(t>A){K=n;J=1;H=j}else H=l+(j-l)*(t/A);if(t==-2||t==A+2)J=H=0;K-=n/2;for(var F=0;F<r;F++){var N=B(F*w*2/u),L=C(F*w*2/u);g[E+0]=N*H;g[E+1]=K;g[E+2]=L*H;m[E+0]=t<0||t>A?0:N*D;m[E+1]=t<0?-1:t>A?1:z;m[E+2]=t<0||t>A?0:L*D;b[G+0]=F/u;b[G+1]=J;G+=2;E+=3}}for(t=0;t<A+a;t++)for(F=0;F<u;F++){l=(t*u+F)*6;q[l+0]=r*(t+0)+0+
F;q[l+1]=r*(t+0)+1+F;q[l+2]=r*(t+1)+1+F;q[l+3]=r*(t+0)+0+F;q[l+4]=r*(t+1)+1+F;q[l+5]=r*(t+1)+0+F}i.Model.call(this,s.extend({vertices:g,normals:m,texCoords:b,indices:q},c||{}))};i.TruncatedCone.prototype=Object.create(i.Model.prototype);i.Cone=function(c){c.topRadius=0;c.topCap=!!c.cap;c.bottomCap=!!c.cap;c.bottomRadius=c.radius||3;i.TruncatedCone.call(this,c)};i.Cone.prototype=Object.create(i.TruncatedCone.prototype);i.Cylinder=function(c){c.bottomRadius=c.radius;c.topRadius=c.radius;i.TruncatedCone.call(this,
c)};i.Cylinder.prototype=Object.create(i.TruncatedCone.prototype);i.Plane=function(c){var l=c.type,j=l.split(","),n=c[j[0]+"len"],u=c[j[1]+"len"],A=c["n"+j[0]]||1;j=c["n"+j[1]]||1;var t=c.offset;numVertices=(A+1)*(j+1);positions=new Float32Array(numVertices*3);normals=new Float32Array(numVertices*3);texCoords=new Float32Array(numVertices*2);for(var v=i3=i2=0;v<=j;v++)for(var a=0;a<=A;a++){var b=a/A,g=v/j;texCoords[i2+0]=b;texCoords[i2+1]=g;i2+=2;switch(l){case "x,y":positions[i3+0]=n*b-n*0.5;positions[i3+
1]=u*g-u*0.5;positions[i3+2]=t;normals[i3+0]=0;normals[i3+1]=0;normals[i3+2]=1;break;case "x,z":positions[i3+0]=n*b-n*0.5;positions[i3+1]=t;positions[i3+2]=u*g-u*0.5;normals[i3+0]=0;normals[i3+1]=1;normals[i3+2]=0;break;case "y,z":positions[i3+0]=t;positions[i3+1]=n*b-n*0.5;positions[i3+2]=u*g-u*0.5;normals[i3+0]=1;normals[i3+1]=0;normals[i3+2]=0}i3+=3}l=A+1;n=[];for(v=0;v<j;v++)for(a=0;a<A;a++){u=(v*A+a)*6;n[u+0]=(v+0)*l+a;n[u+1]=(v+1)*l+a;n[u+2]=(v+0)*l+a+1;n[u+3]=(v+1)*l+a;n[u+4]=(v+1)*l+a+1;n[u+
5]=(v+0)*l+a+1}i.Model.call(this,s.extend({vertices:positions,normals:normals,texCoords:texCoords,indices:n},c))};i.Plane.prototype=Object.create(i.Model.prototype);i.id=s.time();PhiloGL.O3D=i})();(function(){var x={Vertex:{},Fragment:{}},y=x.Fragment;x.Vertex.Default="#define LIGHT_MAX 40\nattribute vec3 position;\nattribute vec3 normal;\nattribute vec4 color;\nattribute vec4 pickingColor;\nattribute vec2 texCoord1;\nuniform mat4 viewMatrix;\nuniform mat4 viewInverseMatrix;\nuniform mat4 projectionMatrix;\nuniform mat4 viewProjectionMatrix;\nuniform mat4 worldMatrix;\nuniform mat4 worldInverseMatrix;\nuniform mat4 worldInverseTransposeMatrix;\nuniform mat4 objectMatrix;\nuniform vec3 cameraPosition;\nuniform bool enableLights;\nuniform vec3 ambientColor;\nuniform vec3 directionalColor;\nuniform vec3 lightingDirection;\nuniform vec3 pointLocation[LIGHT_MAX];\nuniform vec3 pointColor[LIGHT_MAX];\nuniform int numberPoints;\nuniform bool useReflection;\nvarying vec3 vReflection;\nvarying vec4 vColor;\nvarying vec4 vPickingColor;\nvarying vec2 vTexCoord;\nvarying vec4 vNormal;\nvarying vec3 lightWeighting;\nvoid main(void) {\nvec4 mvPosition = worldMatrix * vec4(position, 1.0);\nvec4 transformedNormal = worldInverseTransposeMatrix * vec4(normal, 1.0);\nif(!enableLights) {\nlightWeighting = vec3(1.0, 1.0, 1.0);\n} else {\nvec3 plightDirection;\nvec3 pointWeight = vec3(0.0, 0.0, 0.0);\nfloat directionalLightWeighting = max(dot(transformedNormal.xyz, lightingDirection), 0.0);\nfor (int i = 0; i < LIGHT_MAX; i++) {\nif (i < numberPoints) {\nplightDirection = normalize((viewMatrix * vec4(pointLocation[i], 1.0)).xyz - mvPosition.xyz);\npointWeight += max(dot(transformedNormal.xyz, plightDirection), 0.0) * pointColor[i];\n} else {\nbreak;\n}\n}\nlightWeighting = ambientColor + (directionalColor * directionalLightWeighting) + pointWeight;\n}\nif (useReflection) {\nvReflection = (viewInverseMatrix[3] - (worldMatrix * vec4(position, 1.0))).xyz;\n} else {\nvReflection = vec3(1.0, 1.0, 1.0);\n}\nvColor = color;\nvPickingColor = pickingColor;\nvTexCoord = texCoord1;\nvNormal = transformedNormal;\ngl_Position = projectionMatrix * worldMatrix * vec4(position, 1.0);\n}";
y.Default="#ifdef GL_ES\nprecision highp float;\n#endif\nvarying vec4 vColor;\nvarying vec4 vPickingColor;\nvarying vec2 vTexCoord;\nvarying vec3 lightWeighting;\nvarying vec3 vReflection;\nvarying vec4 vNormal;\nuniform bool hasTexture1;\nuniform sampler2D sampler1;\nuniform bool hasTextureCube1;\nuniform samplerCube samplerCube1;\nuniform bool enablePicking;\nuniform bool hasPickingColors;\nuniform vec3 pickColor;\nuniform float reflection;\nuniform float refraction;\nuniform bool hasFog;\nuniform vec3 fogColor;\nuniform float fogNear;\nuniform float fogFar;\nvoid main(){\nif (!hasTexture1) {\ngl_FragColor = vec4(vColor.rgb * lightWeighting, vColor.a);\n} else {\ngl_FragColor = vec4(texture2D(sampler1, vec2(vTexCoord.s, vTexCoord.t)).rgb * lightWeighting, 1.0);\n}\nif (hasTextureCube1) {\nvec3 nReflection = normalize(vReflection);\nvec3 reflectionValue;\nif (refraction > 0.0) {\nreflectionValue = refract(nReflection, vNormal.xyz, refraction);\n} else {\nreflectionValue = -reflect(nReflection, vNormal.xyz);\n}\nvec4 cubeColor = textureCube(samplerCube1, vec3(-reflectionValue.x, -reflectionValue.y, reflectionValue.z));\ngl_FragColor = vec4(mix(gl_FragColor.xyz, cubeColor.xyz, reflection), 1.0);\n}\nif (enablePicking) {\nif (hasPickingColors) {\ngl_FragColor = vPickingColor;\n} else {\ngl_FragColor = vec4(pickColor, 1.0);\n}\n}\nif (hasFog) {\nfloat depth = gl_FragCoord.z / gl_FragCoord.w;\nfloat fogFactor = smoothstep(fogNear, fogFar, depth);\ngl_FragColor = mix(gl_FragColor, vec4(fogColor, gl_FragColor.w), fogFactor);\n}\n}";
PhiloGL.Shaders=x})();(function(){var x=PhiloGL.Vec3,y=!!(navigator&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/firefox/)),p=function(k,f,d){d=s.merge({lights:{enable:false,ambient:{r:0.2,g:0.2,b:0.2},directional:{direction:{x:1,y:1,z:1},color:{r:0,g:0,b:0}}},effects:{fog:false}},d||{});this.program=d.program?k[d.program]:k;this.camera=f;this.models=[];this.config=d};p.prototype={add:function(){for(var k=0,f=this.models,d=arguments.length;k<d;k++){var h=arguments[k];h.id=h.id||
s.uid();f.push(h);this.defineBuffers(h)}},remove:function(k){var f=this.models;k=f.indexOf(k);k>-1&&f.splice(k,1)},getProgram:function(k){var f=this.program;if(f.$$family!="program"&&k&&k.program){f=f[k.program];f.use()}return f},defineBuffers:function(k){var f=this.getProgram(k),d=k.dynamic;k.dynamic=true;k.setState(f);k.dynamic=d;k.unsetState(f)},beforeRender:function(k){this.setupLighting(k);this.setupEffects(k);var f=this.camera,d=f.position,h=f.view;f=f.projection;var i=h.mulMat4(f),c=i.invert();
k.setUniforms({cameraPosition:[d.x,d.y,d.z],projectionMatrix:f,viewMatrix:h,viewProjectionMatrix:i,viewInverseMatrix:h.invert(),viewProjectionInverseMatrix:c})},setupLighting:function(k){var f=this.config.lights,d=f.ambient,h=f.directional,i=h.color,c=h.direction,l=f.enable;f=f.points&&s.splat(f.points)||[];h=f.length;var j=[],n=[],u=[],A=[];c=(new x(c.x,c.y,c.z)).$unit().$scale(-1);k.setUniform("enableLights",l);if(l){k.setUniform("ambientColor",[d.r,d.g,d.b]);k.setUniform("directionalColor",[i.r,
i.g,i.b]);k.setUniform("lightingDirection",[c.x,c.y,c.z]);k.setUniform("numberPoints",h);for(d=0;d<h;d++){l=f[d];i=l.position;c=l.color||l.diffuse;l=l.specular;j.push(i.x,i.y,i.z);n.push(c.r,c.g,c.b);u.push(+!!l);l?A.push(l.r,l.g,l.b):A.push(0,0,0)}k.setUniforms({pointLocation:j,pointColor:n});k.setUniforms({enableSpecular:u,pointSpecularColor:A})}},setupEffects:function(k){var f=this.config.effects.fog,d=f.color||{r:0.5,g:0.5,b:0.5};f?k.setUniforms({hasFog:true,fogNear:f.near,fogFar:f.far,fogColor:[d.r,
d.g,d.b]}):k.setUniform("hasFog",false)},render:function(k){k=k||{};var f=this.camera,d=this.program,h=k.renderProgram,i=s.type(d);i=!h&&i=="object";k=s.extend({onBeforeRender:s.empty,onAfterRender:s.empty},k||{});!i&&this.beforeRender(h||d);for(var c=0,l=this.models,j=l.length;c<j;++c){var n=l[c];if(n.display){d=h||this.getProgram(n);i&&this.beforeRender(d);n.onBeforeRender(d,f);k.onBeforeRender(n,c);this.renderObject(n,d);k.onAfterRender(n,c);n.onAfterRender(d,f)}}},renderToTexture:function(k,f){f=
f||{};var d=I.textures[k+"-texture"],h=I.textureMemo[k+"-texture"];this.render(f);o.bindTexture(h.textureType,d);o.generateMipmap(h.textureType);o.bindTexture(h.textureType,null)},renderObject:function(k,f){var d=this.camera,h=k.matrix,i=d.view.mulMat4(h),c=i.invert(),l=c.transpose();k.setState(f);f.setUniforms({objectMatrix:h,worldMatrix:i,worldInverseMatrix:c,worldInverseTransposeMatrix:l});if(k.render)k.render(o,f,d);else k.$indicesLength?o.drawElements(k.drawType!==undefined?o.get(k.drawType):
o.TRIANGLES,k.$indicesLength,o.UNSIGNED_SHORT,0):o.drawArrays(k.drawType!==undefined?o.get(k.drawType):o.TRIANGLES,0,k.$verticesLength/3);k.unsetState(f)},setupPicking:function(){var k=PhiloGL.Program.fromDefaultShaders(),f=p.PICKING_RES,d=Math.floor;I.setFrameBuffer("$picking",{width:d(I.canvas.width/f),height:d(I.canvas.height/f),bindToTexture:{parameters:[{name:"TEXTURE_MAG_FILTER",value:"LINEAR"},{name:"TEXTURE_MIN_FILTER",value:"LINEAR",generateMipmap:y}]},bindToRenderBuffer:true});I.setFrameBuffer("$picking",
false);this.pickingProgram=k},pick:function(k,f,d){this.pickingProgram||this.setupPicking();if(d&&this.capture)return this.lazyPick(k,f);var h={},i=[],c=I.usedProgram,l=this.pickingProgram,j=p.PICKING_RES,n=this.config,u=n.lights.enable,A=n.effects.fog,t=o.canvas.height,v=Math.floor,a=v(o.canvas.width/j),b=v(t/j),g=[],m=new Uint8Array(4),q=0,r,w;n.lights.enable=false;n.effects.fog=false;I.setFrameBuffer("$picking",true);l.use();l.setUniform("enablePicking",true);o.disable(o.BLEND);o.viewport(0,0,
a,b);o.clear(o.COLOR_BUFFER_BIT|o.DEPTH_BUFFER_BIT);o.readPixels(0,0,1,1,o.RGBA,o.UNSIGNED_BYTE,m);r=m[0]+m[1]*256+m[2]*65536;this.renderToTexture("$picking",{renderProgram:l,onBeforeRender:function(z,B){if(B==r)q=1;var C=B+q,D=!!z.pickingColors;l.setUniform("hasPickingColors",D);if(D)i.push(z);else{g[0]=C%256;g[1]=(C/256>>0)%256;g[2]=(C/65536>>0)%256;l.setUniform("pickColor",[g[0]/255,g[1]/255,g[2]/255]);h[g.join()]=z}}});if(d){w=new Uint8Array(4*a*b);o.readPixels(0,0,a,b,o.RGBA,o.UNSIGNED_BYTE,
w);m=v((k+(t-f)*a)/j)*4;m=[w[m],w[m+1],w[m+2],w[m+3]]}else o.readPixels(v(k/j),v((t-f)/j),1,1,o.RGBA,o.UNSIGNED_BYTE,m);k=[m[0],m[1],m[2]].join();k=h[k];if(!k){d=0;for(j=i.length;d<j;d++){k=i[d];f=k.pick(m);if(f!==false)k.$pickingIndex=f;else k=false}}I.setFrameBuffer("$picking",false);I.setTexture("$picking-texture",false);l.setUniform("enablePicking",false);n.lights.enable=u;n.effects.fog=A;c&&c.use();o.viewport(0,0,I.canvas.width,I.canvas.height);this.o3dHash=h;this.o3dList=i;this.pixel=m;this.capture=
w;return k&&k.pickable&&k},lazyPick:function(k,f){var d=I.canvas,h=p.PICKING_RES,i=Math.floor;d=i((k+(d.height-f)*(d.width/h>>0))/h)*4;h=this.capture;d=[h[d],h[d+1],h[d+2],h[d+3]];h=this.o3dList;i=this.o3dHash[[d[0],d[1],d[2]].join()];var c;if(!i)for(var l=0,j=h.length;l<j;l++){i=h[l];c=i.pick(d);if(c!==false)i.$pickingIndex=c;else i=false}return i&&i.pickable&&i},resetPicking:function(){this.capture=false}};p.MAX_TEXTURES=10;p.MAX_POINT_LIGHTS=50;p.PICKING_RES=4;PhiloGL.Scene=p})();(function(){function x(y,
p){for(var k=this.workers=[];p--;)k.push(new Worker(y))}x.prototype={map:function(y){var p=this.workers,k=this.configs=[],f=0;for(p=p.length;f<p;f++)k.push(y&&y(f));return this},reduce:function(y){for(var p=y.reduceFn,k=this.workers,f=this.configs,d=k.length,h=y.initialValue,i=function(n){d--;h=h===undefined?n.data:p(h,n.data);if(d==0)y.onComplete(h)},c=0,l=d;c<l;c++){var j=k[c];j.onmessage=i;j.postMessage(f[c])}return this}};PhiloGL.WorkerGroup=x})();(function(){var x=function(h){this.opt=s.merge({delay:0,
duration:1E3,transition:function(i){return i},onCompute:s.empty,onComplete:s.empty},h||{})},y=x.Queue=[];x.prototype={time:null,start:function(h){this.opt=s.merge(this.opt,h||{});this.time=s.time();this.animating=true;y.push(this)},step:function(){if(this.animating){var h=s.time(),i=this.time,c=this.opt,l=c.delay,j=c.duration,n=0;if(h<i+l)c.onCompute.call(this,n);else if(h<i+l+j){n=c.transition((h-i-l)/j);c.onCompute.call(this,n)}else{this.animating=false;c.onCompute.call(this,1);c.onComplete.call(this)}}}};
x.compute=function(h,i,c){return h+(i-h)*c};x.Transition={linear:function(h){return h}};var p=x.Transition;(function(){var h=function(l,j){j=s.splat(j);return s.extend(l,{easeIn:function(n){return l(n,j)},easeOut:function(n){return 1-l(1-n,j)},easeInOut:function(n){return n<=0.5?l(2*n,j)/2:(2-l(2*(1-n),j))/2}})},i={Pow:function(l,j){return Math.pow(l,j[0]||6)},Expo:function(l){return Math.pow(2,8*(l-1))},Circ:function(l){return 1-Math.sin(Math.acos(l))},Sine:function(l){return 1-Math.sin((1-l)*Math.PI/
2)},Back:function(l,j){j=j[0]||1.618;return Math.pow(l,2)*((j+1)*l-j)},Bounce:function(l){for(var j,n=0,u=1;;n+=u,u/=2)if(l>=(7-4*n)/11){j=u*u-Math.pow((11-6*n-11*l)/4,2);break}return j},Elastic:function(l,j){return Math.pow(2,10*--l)*Math.cos(20*l*Math.PI*(j[0]||1)/3)}},c;for(c in i)p[c]=h(i[c]);["Quad","Cubic","Quart","Quint"].forEach(function(l,j){p[l]=h(function(n){return Math.pow(n,[j+2])})})})();var k=self||window,f=function(){var h=[];if(y.length){for(var i=0,c=y.length,l;i<c;i++){l=y[i];l.step();
l.animating&&h.push(l)}x.Queue=y=h}};if(k){var d=false;["webkitAnimationTime","mozAnimationTime","animationTime","webkitAnimationStartTime","mozAnimationStartTime","animationStartTime"].forEach(function(h){if(h in k){x.animationTime=function(){return k[h]};d=true}});if(!d)x.animationTime=s.time;d=false;["webkitRequestAnimationFrame","mozRequestAnimationFrame","requestAnimationFrame"].forEach(function(h){if(h in k){x.requestAnimationFrame=function(i){k[h](function(){f();i()})};d=true}});if(!d)x.requestAnimationFrame=
function(h){setTimeout(function(){f();h()},1E3/60)}}PhiloGL.Fx=x})();(function(){var x={},y=function(){};y.postProcess=function(){var p=new PhiloGL.O3D.Plane({type:"x,y",xlen:1,ylen:1,offset:0}),k=new PhiloGL.Camera(45,1,0.1,500,{position:{x:0,y:0,z:1.205}}),f=new PhiloGL.Scene({},k);return function(d){var h=I.program.$$family?I.program:I.program[d.program],i=d.fromTexture?s.splat(d.fromTexture):[],c=d.toFrameBuffer,l=!!d.toScreen,j=d.width||I.canvas.width,n=d.height||I.canvas.height;k.aspect=d.aspectRatio?
d.aspectRatio:Math.max(n/j,j/n);k.update();f.program=h;p.textures=i;p.program=h;f.models.length||f.add(p);if(c){c in I.frameBufferMemo||I.setFrameBuffer(c,{width:j,height:n,bindToTexture:{parameters:[{name:"TEXTURE_MAG_FILTER",value:"LINEAR"},{name:"TEXTURE_MIN_FILTER",value:"LINEAR_MIPMAP_NEAREST",generateMipmap:false}]},bindToRenderBuffer:true});h.use();I.setFrameBuffer(c,true);o.viewport(0,0,j,n);o.clear(o.COLOR_BUFFER_BIT|o.DEPTH_BUFFER_BIT);h.setUniforms(d.uniforms||{});f.renderToTexture(c);
I.setFrameBuffer(c,false)}if(l){h.use();o.viewport(0,0,j,n);o.clear(o.COLOR_BUFFER_BIT|o.DEPTH_BUFFER_BIT);h.setUniforms(d.uniforms||{});f.render()}return this}}();x.Image=y;PhiloGL.Media=x})()})();
